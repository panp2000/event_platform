1.ディレクトリを掘り移動し`npx create-react-app@latest`
`Eslint no` 以外はデフォルト

2.`npm run dev`

3.`npm shadcn-ui@latest init`
`Where is your tailwind.config.js located? … tailwind.config.ts`
以外はデフォルト

4.`npx shadcn-ui@latest add button`
5.`page.tsx`にボタンコンポーネントを配置
```typescript
export default function Home() {
  return (
    <main>
      <Button>Hello</Button>
    </main>
  )
}
```

6.ボタンの外見変更
```typescript
export default function Home() {
  return (
    <main>
//       <Button>Hello</Button>
       <Button variant="destructive">Delete</Button>
    </main>
  )
}
```

7.`tailwind`のクラスを追加して外見を整える
```typescript
export default function Home() {
  return (
    <main>
      // <Button variant="destructive">Delete</Button> 変更
      <Button variant="destructive" className='px-10'>Delete</Button>
    </main>
  )
}
```

8.`app/glabal.css` を変更
`https://raw.githubusercontent.com/adrianhajdin/event_platform/main/app/globals.css`
をコピペ

9.`tailwind.config.ts` を変更
`https://raw.githubusercontent.com/adrianhajdin/event_platform/main/tailwind.config.ts`
をコピペ

10.`npm i uploadthing @uploadthing/react`
エラー解消のため開発サーバーは再起動する

11.`page.tsx`にタイトルを追加
```typescript
export default function Home() {
  return (
    <main>
      <h1 className="text-4xl">Evently</h1>
      <Button variant="destructive" className='px-10'>Delete</Button>
    </main>
  )
}
```

12.`app/(root)` フォルダを作成し、page.tsxを移動
13.`app/(auth)` フォルダを作成し、page
14.`layout.tsx` を変更(フォントを`Inter`から`Poppins`に変更)
```typescript
import type { Metadata } from 'next';
import { Poppins } from 'next/font/google';
import './globals.css';

const poiins = Poppins({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  variable: '--font-poppins'
});

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={poiins.variable}>{children}</body>
    </html>
  );
}
```

15.`public`フォルダに`https://github.com/adrianhajdin/event_platform/tree/main/public/assets`をダウンロードして保存
16.`app`フォルダに`https://github.com/adrianhajdin/event_platform/blob/main/app/favicon.ico`をダウンロードして保存
17.`/app/layout.tsx`を修正、フォント変更、タイトル・説明変更、Favicon変更
```typescript
import type { Metadata } from 'next';
import { Poppins } from 'next/font/google'; //変更
import './globals.css';

// ここから変更
const poiins = Poppins({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  variable: '--font-poppins'
});
// ここまで

export const metadata: Metadata = {
  // ここから変更
  title: 'Evently',
  description: 'Evently はイベント管理のためのプラットフォームです。',
  icons: {
    icon: '/assets/images/logo.svg',
  },
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={poiins.variable}>{children}</body> // 変更
    </html>
  );
}

// ここまで
```
18.`/app/(root)/layout.tsx`を新規作成
19.`/app/layout.tsx`から`RootLayout`ファンクションをコピーし`/app/(root)/layout.tsx`に貼り付け、`body`の`className`を削除
20.`/components/shared`フォルダを作成
21.`/components/shared`フォルダに`Header.tsx`と`Footer.tsx`を作成し、rafceをする
22.`/app/(root)/layout.tsx`に上で作った２つのコンポーネントを配置する
23.`/app/(root)/layout.tsx`を整える
```typescript
import Footer from "@/components/shared/Footer";
import Header from "@/components/shared/Header";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <div className="flex h-screen flex-col">
      <Header />
      <main className="flex-1">{children}</main>
      <Footer />
      </div>
    </html>
  );
}
```
24.`https://dashboard.clerk.com/apps/new`で`SignIn`コンポーネントを作成(23:00ごろ)
25.`.env.local`を作成し、上で作成した環境変数をコピペする
26.指示に従ってclerkをインストールしていく(`ClerkProvider`は`/app/layout.tsx`に記述する)
27.`middleware.ts`をルートに作成してコピペして修正(上の24からの続き)
```typescript
import { authMiddleware } from "@clerk/nextjs";

// This example protects all routes including api/trpc routes
// Please edit this to allow other routes to be public as needed.
// See https://clerk.com/docs/references/nextjs/auth-middleware for more information about configuring your Middleware
export default authMiddleware({
  publicRoutes: [
    '/',
    '/events/:id',
    '/api/webhook/clerk',
    '/api/webhook/stripe',
    '/api/uploadthing'
  ],
  ignoredRoutes: [
    '/api/webhook/clerk',
    '/api/webhook/stripe',
    '/api/uploadthing'
  ]
});

export const config = {
  matcher: ['/((?!.+\\.[\\w]+$|_next).*)', '/', '/(api|trpc)(.*)'],
};
```
28.`/app/(auth)/sign-in/[[...sign-in]]`フォルダを作成し、直下に`page.tsx`作成
```typescript
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return <SignIn />
}
```
29.[(ここから`https://clerk.com/docs/references/nextjs/custom-signup-signin-pages`の作業)](https://clerk.com/docs/references/nextjs/custom-signup-signin-pages) 同様に`/app/(auth)/sign-up/[[...sign-up]]/page.tsx`を作成
※フォルダのダブルブラケット`[[]]`は[オプショナルにすべてのルートを受け取る](https://nextjs-ja-translation-docs.vercel.app/docs/routing/dynamic-routes#%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AB%E3%81%AB%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%88%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B "オプショナルにすべてのルートを受け取る")

30.ドキュメントに従い`.env.local`に環境変数を追加
31.[(ここから`Localization prop (Experimental)`の作業)](https://clerk.com/docs/components/customization/localization) `npm install @clerk/localizations`
32.`/app/layout.tsx`を修正(~~現時点で日本語化ならず~~ 開発サーバー再起動で日本語化)
```typescript
import type { Metadata } from 'next';
import { Poppins } from 'next/font/google';
import './globals.css';
import { ClerkProvider } from '@clerk/nextjs';
import { jaJP } from '@clerk/localizations'; // 追加

const poiins = Poppins({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  variable: '--font-poppins'
});

export const metadata: Metadata = {
  title: 'Evently',
  description: 'Evently はイベント管理のためのプラットフォームです。',
  icons: {
    icon: '/assets/images/logo.svg',
  },
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ClerkProvider localization={jaJP}> // 修正
      <html lang="ja">
        <body className={poiins.variable}>{children}</body>
      </html>
    </ClerkProvider>
  );
}
```

33.`/app/(auth)/layout.tsx`を作成
```typescript
const Layout = ({ children }: { children: React.ReactNode; }) => {
  return (
    <div className="flex-center min-h-screen w-full bg-primary-50 bg-dotted-pattern bg-cover bg-fixed bg-center">
      {children}
    </div>
  );
};

export default Layout;
```

34.`/components/shared/Header.tsx`を修正
```typescript
import { SignedOut } from "@clerk/nextjs";
import Image from "next/image";
import Link from "next/link";
import { Button } from "../ui/button";

const Header = () => {
  return (
    <header className="w-full border-b">
      <div className="wrapper flex items-center justify-between">
        <Link href="/" className="w-36">
          <Image src="/assets/images/logo.svg" width={128} height={38} alt="Evently logo"></Image>
        </Link>

        <div className="flex w-32 justify-end gap-3">
          <SignedOut>
            <Button asChild className="rounded-full" size='lg'>
              <Link href='/sign-in'>
                Login
              </Link>
            </Button>
          </SignedOut>
        </div>
      </div>
    </header>
  );
};

export default Header;
```

35.`/components/shared/Header.tsx`にログアウト処理追加
```typescript
        <div className="flex w-32 justify-end gap-3">
        // 追加ここから
          <SignedIn>
            <UserButton afterSignOutUrl="/" />
          </SignedIn>
        // ここまで
          <SignedOut>
            <Button asChild className="rounded-full" size='lg'>
              <Link href='/sign-in'>
                Login
              </Link>
            </Button>
          </SignedOut>
        </div>
```

36.`/components/shared/NavItems.tsx`を新規作成
37.`rafce`
38.`/components/shared/Header.tsx`に上で作成した`NavItems.tsx`を追加
```typescript
          <SignedIn>
            <UserButton afterSignOutUrl="/" />
            <NavItems /> // 追加
          </SignedIn>
```

39.`/components/shared/Header.tsx`内に`SignedIn`コンポーネントを別で作成する
```typescript
// 追加
        <SignedIn>
          <nav className="md:flex-between hidden w-full max-w-xs">
            <NavItems />
          </nav>
        </SignedIn>
// 追加ここまで

        <div className="flex w-32 justify-end gap-3">
```

40.`/components/shared/MobileNav.tsx`を新規作成
41.`rafce`
42.`/components/shared/Header.tsx`内の以前の`NavItems`コンポーネントを`MobileNav`に入れ替える
```typescript
          <SignedIn>
            <UserButton afterSignOutUrl="/" />
            <MobileNav /> // 変更
          </SignedIn>
```

43.`https://ui.shadcn.com/docs/components/sheet`から`sheet`コンポーネントをインストール
```bash
npx shadcn-ui@latest add sheet
```
44.`/components/shared/MobileNav.tsx`に`sheet`コンポーネントに必要な`import`を追加
```typescript
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet"
```
45.サンプルコードをコピペ
```typescript
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";

const MobileNav = () => {
  return (
    <nav className="md:hidden">
      <Sheet>
        <SheetTrigger>Open</SheetTrigger>
        <SheetContent>
          <SheetHeader>
            <SheetTitle>Are you sure absolutely sure?</SheetTitle>
            <SheetDescription>
              This action cannot be undone. This will permanently delete your account
              and remove your data from our servers.
            </SheetDescription>
          </SheetHeader>
        </SheetContent>
      </Sheet>
    </nav>
  );
};
export default MobileNav;
```
46.ハンバーガーメニューを表示
```typescript
        <SheetTrigger className="align-middle">
          <Image
            src="/assets/icons/menu.svg"
            width={24}
            height={24}
            alt="menu"
            className="cursor-pointer"
          />
        </SheetTrigger>
```
47.ハンバーガークリック後にロゴを表示
```typescript
        <SheetContent className="flex flex-col gap-6 bg-white md:hidden">
          <Image
            src="/assets/images/logo.svg"
            alt="logo"
            width={128}
            height={38}
          />
        </SheetContent>
```
48.`https://ui.shadcn.com/docs/components/separator`から`separator`をインストール
```bash
npx shadcn-ui@latest add separator
```
49.ロゴの下に境界線と`NavItems`を追加
```typescript
        <SheetContent className="flex flex-col gap-6 bg-white md:hidden">
          <Image
            src="/assets/images/logo.svg"
            alt="logo"
            width={128}
            height={38}
          />
          // 追加
          <Separator className="border border-gray-50" />
          <NavItems />
          // 追加ここまで
        </SheetContent>
```
50.`/constants/index.ts`を作成
51.`https://github.com/adrianhajdin/event_platform/blob/main/constants/index.ts`から`/constants/index.ts`にコピペ
52.`/components/shared/NavItems.tsx`を修正して、ヘッダーリンクを表示させる
```typescript
import { headerLinks } from "@/constants";
import Link from "next/link";

const NavItems = () => {
  return (
    <ul className="md:flex-between flex w-full flex-col items-start gap-5 md:flex-row">
      {headerLinks.map((link) => {
        return (
          <li key={link.route}>
            <Link href={link.route}>
              {link.label}
            </Link>
          </li>
        )
      })}
    </ul>
  )
}
export default NavItems
```

53.現在表示中のページの表示色を変え、リンクもしないようにする
```typescript
'use client';

import { headerLinks } from "@/constants";
import Link from "next/link";
import { usePathname } from "next/navigation";

const NavItems = () => {
  const pathname = usePathname();

  return (
    <ul className="md:flex-between flex w-full flex-col items-start gap-5 md:flex-row">
      {headerLinks.map((link) => {
        const isActive = link.route === pathname;

        return (
          <li
            key={link.route}
            className={isActive ? "text-primary-500 flex-center p-medium-16 whitespace-nowrap" : ""}
          >
            {isActive ? link.label : (<Link href={link.route}>{link.label}</Link>)}
          </li>
        );
      })}
    </ul>
  );
};
export default NavItems;
```

Section `46:06`フッター作成開始
54.`/components/shared/Footer.tsx`を修正
```typescript
import Link from "next/link";
import Image from "next/image";

const Footer = () => {
  return (
    <footer className="border-t">
      <div className="flex-center wrapper flex-between flex flex-col gap-4 p-5 text-center sm:flex-row">
        <Link href="/">
          <Image
            src="/assets/images/logo.svg"
            width={128}
            height={38}
            alt="Evently logo" />
        </Link>

        <p>2023 Evently. All Rights reserved.</p>
      </div>
    </footer>
  );
};
export default Footer;
```

Section `48:27` メインコンテンツ

55.ヒーローセクション作成
```typescript
import { Button } from '@/components/ui/button';
import Image from 'next/image';
import Link from 'next/link';

export default function Home() {
  return (
    <>
      <section className='bg-primary-50 bg-dotted-pattern bg-contain py-5 md:py-10'>
        <div className="wrapper grid grid-cols-1 gap-5 md:grid-cols-2 2xl:gap-0">
          <div className="flex flex-col justify-center gap-8">
            <h1 className='h1-bold'>Host, Connect, Celebrate: Your Events, Our Platform!</h1>
            <p className="r-regular-20 md:p-regular-24">
              Book and learn helpful tips from 3,168+ mentors in world-class companies with our global community.
            </p>
            <Button size='lg' asChild className='button w-full sm:w-fit'>
              <Link href="#events">
                Explore Now
              </Link>
            </Button>
          </div>
          <Image
            src="/assets/images/hero.png"
            alt="hero"
            width={1000}
            height={1000}
            className='max-h-[70vh] object-contain object-center 2xl:max-h-[50vh]'
          />
        </div>
      </section>
    </>
  );
}
```
56.イベントセクション雛形作成
ヒーローセクション下に以下を追加
```typescript
      <section id="events" className='wrapper my-8 flex flex-col gap-8 md:gap-12'>
        <h2 className="h2-bold">Trust by <br /> Thousands of Events</h2>

        <div className='flex w-full flex-col gap-5 md:flex-row'>
          Search
          CategoryFilter
        </div>
      </section>
```

Section バックエンド 55:49
データベースのセットアップ
57.MongoDB Connection
`npm i mongoose mongodb`
58.`https://mongodb.com`にログインし、`Evently`プロジェクトを作成
59.左メニューから`Database`クリック後中頃の`Build a Database`をクリックして`M0 FREE`をクリック
60.`Username`と`Password`を入力して`Create User`をクリックし`Finish and Close`をクリック
61.左の`Network Access`をクリックし右の`+ADD IP ADDRESS`をクリック、`ALLOW ACCESS FROM ANYWHERE`をクリック後`Confirm`をクリック
62.左の`Overview`クリックして`CONNECT`→`Drivers`をクリック
63.`3. Add your connection string into your application code`内の`URI`を`.env.local`にコピペ
64.`MONGODB_URI=`を`URI`の前に加え、`URI`中の`<password>`を適切なものに書き換え
データベースセットアップ終わり

65.`/lib/database/index.ts`を作成
```typescript
import mongoose from 'mongoose';

const MONGODB_URI = process.env.MONGODB_URI;

let cached = (global as any).mongoose || { conn: null, promise: null };

export const connectToDatabase = async () => {
  if (cached.conn) return cached.conn;

  if (!MONGODB_URI) throw new Error('MONGODB_URI is missing');

  cached.promise = cached.promise || mongoose.connect(MONGODB_URI, {
    dbName: 'evently',
    bufferCommands: false
  });

  cached.conn = await cached.promise;

  return cached.conn;
};
```
1:03:50
66.`/lib/database/models/user.model.ts`を作成
```typescript
import { Schema, model, models } from "mongoose";

const UserSchema = new Schema({
  clerkId: { type: String, required: true, unique: true },
  email: { type: String, required: true, unique: true },
  username: { type: String, required: true, unique: true },
  firstname: { type: String, required: true },
  lastname: { type: String, required: true },
  photo: { type: String, required: true }
});

const User = models.User || model("User", UserSchema);

export default User;
```

67.`/lib/database/models/event.model.ts`を作成
```typescript
import { Document, Schema, model, models } from "mongoose";

export interface IEvent extends Document {
  _id: string;
  title: string;
  description?: string;
  location?: string;
  createdAt: Date;
  imageUrl: string;
  startDateTime: Date;
  endDatTime: Date;
  price?: string;
  isFree: boolean;
  url?: string;
  category: { _id: string, name: string; };
  organizer: { _id: string, firstName: string, lastName: string; };
}

const EventSchema = new Schema({
  title: { type: String, required: true },
  description: { type: String },
  location: { type: String },
  createdAt: { type: Date, default: Date.now },
  imageUrl: { type: String, required: true },
  startDateTime: { type: Date, required: true },
  endDatTime: { type: Date, default: Date.now },
  price: { type: String },
  isFree: { type: Boolean, default: false },
  url: { type: String },
  category: { type: Schema.Types.ObjectId, ref: "Category" },
  organizer: { type: Schema.Types.ObjectId, ref: "User" },
});

const Event = models.Event || model("Event", EventSchema);

export default Event;
```

68.`https://clerk.com/docs/users/sync-data`に従ってユーザーデータを作っていく
`Clerk`ダッシュボードの左メニューから`Webhooks`をクリック
69.右端の`Add Endpoint`をクリック
70.ローカルマシンのコンソールで`npm install svix`
71.`/app/api/webhook/clerk/route.ts`を作成し、`https://clerk.com/docs/users/sync-data#create-the-endpoint-in-your-application`のコードをコピペし一部修正
```typescript
import { Webhook } from 'svix'
import { headers } from 'next/headers'
import { WebhookEvent } from '@clerk/nextjs/server'
 
export async function POST(req: Request) {
 
  // You can find this in the Clerk Dashboard -> Webhooks -> choose the webhook
  const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET
 
  if (!WEBHOOK_SECRET) {
    throw new Error('Please add WEBHOOK_SECRET from Clerk Dashboard to .env or .env.local')
  }
 
  // Get the headers
  const headerPayload = headers();
  const svix_id = headerPayload.get("svix-id");
  const svix_timestamp = headerPayload.get("svix-timestamp");
  const svix_signature = headerPayload.get("svix-signature");
 
  // If there are no headers, error out
  if (!svix_id || !svix_timestamp || !svix_signature) {
    return new Response('Error occured -- no svix headers', {
      status: 400
    })
  }
 
  // Get the body
  const payload = await req.json()
  const body = JSON.stringify(payload);
 
  // Create a new Svix instance with your secret.
  const wh = new Webhook(WEBHOOK_SECRET);
 
  let evt: WebhookEvent
 
  // Verify the payload with the headers
  try {
    evt = wh.verify(body, {
      "svix-id": svix_id,
      "svix-timestamp": svix_timestamp,
      "svix-signature": svix_signature,
    }) as WebhookEvent
  } catch (err) {
    console.error('Error verifying webhook:', err);
    return new Response('Error occured', {
      status: 400
    })
  }
 
  // Get the ID and type
  const { id } = evt.data;
  const eventType = evt.type;
 
// 修正
  if(eventType==='user.created') {
    const {id,email_addresses,image_url,first_name,last_name,username} = evt.data

    const user = {
      clertkId: id,
      email: email_addresses[0].email_address,
      username: username,
      first_name: first_name,
      last_name: last_name,
      photo: image_url
    }

    // const newUser = await createSecureServer(user)
// 修正ここまで
 
  return new Response('', { status: 200 })
}
```
72.`/types/index.ts`を作成し`https://github.com/adrianhajdin/event_platform/blob/main/types/index.ts`からコピペ
73.`/lib/utils.ts`に`https://github.com/adrianhajdin/event_platform/blob/main/lib/utils.ts`の内容をコピペ
74.`npm i query-string`を実行
75.`/lib/actions/user.action.ts`を作成
```typescript
import { Webhook } from 'svix';
import { headers } from 'next/headers';
import { WebhookEvent } from '@clerk/nextjs/server';
import { createUser, updateUser, deleteUser } from '@/lib/actions/user.action';
import { clerkClient } from '@clerk/nextjs';
import { NextResponse } from 'next/server';

export async function POST(req: Request) {

  // You can find this in the Clerk Dashboard -> Webhooks -> choose the webhook
  const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET;

  if (!WEBHOOK_SECRET) {
    throw new Error('Please add WEBHOOK_SECRET from Clerk Dashboard to .env or .env.local');
  }

  // Get the headers
  const headerPayload = headers();
  const svix_id = headerPayload.get("svix-id");
  const svix_timestamp = headerPayload.get("svix-timestamp");
  const svix_signature = headerPayload.get("svix-signature");

  // If there are no headers, error out
  if (!svix_id || !svix_timestamp || !svix_signature) {
    return new Response('Error occured -- no svix headers', {
      status: 400
    });
  }

  // Get the body
  const payload = await req.json();
  const body = JSON.stringify(payload);

  // Create a new Svix instance with your secret.
  const wh = new Webhook(WEBHOOK_SECRET);

  let evt: WebhookEvent;

  // Verify the payload with the headers
  try {
    evt = wh.verify(body, {
      "svix-id": svix_id,
      "svix-timestamp": svix_timestamp,
      "svix-signature": svix_signature,
    }) as WebhookEvent;
  } catch (err) {
    console.error('Error verifying webhook:', err);
    return new Response('Error occured', {
      status: 400
    });
  }

  // Get the ID and type
  const { id } = evt.data;
  const eventType = evt.type;

  if (eventType === 'user.created') {
    const { id, email_addresses, image_url, first_name, last_name, username } = evt.data;

    const user = {
      clerkId: id,
      email: email_addresses[0].email_address,
      username: username!,
      firstName: first_name,
      lastName: last_name,
      photo: image_url
    };

    const newUser = await createUser(user);

    if (newUser) {
      await clerkClient.users.updateUserMetadata(id, {
        publicMetadata: {
          userId: newUser._id
        }
      });
    }

    return NextResponse.json({ message: 'OK', user: newUser });
  }

  if (eventType === 'user.updated') {
    const { id, image_url, first_name, last_name, username } = evt.data;

    const user = {
      username: username!,
      firstName: first_name,
      lastName: last_name,
      photo: image_url
    };

    const updatedUser = await updateUser(id, user);

    return NextResponse.json({ message: 'OK', user: updatedUser });
  }

  if (eventType === 'user.deleted') {
    const { id } = evt.data;

    const deletedUser = await deleteUser(id);

    return NextResponse.json({ message: 'OK', user: deletedUser });
  }

  return new Response('', { status: 200 });
}
```
76.`/lib/actions/user.action.ts`に`updateUser`と`deleteUser`、`getUserById`を実装する
```typescript
export const deleteUser = async (clerkId: string) => {
  try {
    await connectToDatabase();

    const userToDelete = await User.findOne({ clerkId });

    if (!userToDelete) {
      throw new Error("User not found");
    };

    await Promise.all([
      // Update the 'events' collection to remove references to the user
      Event.updateMany({
        _id: { $in: userToDelete.orders }
      }, {
        $unset: { buyer: 1 }
      })
    ]);

    // Delete user
    const deletedUser = await User.findByIdAndDelete(userToDelete._id);
    revalidatePath('/');

    return deletedUser ? JSON.stringify(deletedUser) : null;
  } catch (error) {
    handleError(error);
  }
};

export const updateUser = async (clerkId: string, user: UpdateUserParams) => {
  try {
    await connectToDatabase();

    const updatedUser = await User.findOneAndUpdate({ clerkId }, user, { new: true });

    if (!updatedUser) throw new Error("User update failed");
    return JSON.parse(JSON.stringify(updatedUser));
  } catch (error) {
    handleError(error);
  }
};

export const getUserById = async (clerkId: string) => {
  try {
    await connectToDatabase();

    const user = await User.findById(clerkId);

    if (!user) throw new Error("User not found");
    return JSON.parse(JSON.stringify(user));
  } catch (error) {
    handleError(error);
  }
};
```

1:25:50
77.`/lib/database/models/category.model.ts`を作成
```typescript
import { Document, Schema, model, models } from "mongoose";

export interface ICategory extends Document {
  _id: string;
  name: string;
}

const CategorySchema = new Schema({
  name: {
    type: String,
    required: true,
    unique: true
  },
});

const Category = models.Category || model("Category", CategorySchema);

export default Category;
```
78.`/lib/database/models/order.model.ts`を作成
```typescript
import { Schema, model, models, Document } from 'mongoose';

export interface IOrder extends Document {
  createdAt: Date;
  stripeId: string;
  totalAmount: string;
  event: {
    _id: string;
    title: string;
  };
  buyer: {
    _id: string;
    firstName: string;
    lastName: string;
  };
}

export type IOrderItem = {
  _id: string;
  totalAmount: string;
  createdAt: Date;
  eventTitle: string;
  eventId: string;
  buyer: string;
};

const OrderSchema = new Schema({
  createdAt: {
    type: Date,
    default: Date.now,
  },
  stripeId: {
    type: String,
    required: true,
    unique: true,
  },
  totalAmount: {
    type: String,
  },
  event: {
    type: Schema.Types.ObjectId,
    ref: 'Event',
  },
  buyer: {
    type: Schema.Types.ObjectId,
    ref: 'User',
  },
});

const Order = models.Order || model('Order', OrderSchema);

export default Order;
```
79.`/lib/actions/user.action.ts`を以下の修正を加える
```typescript
//追加
import Order from '@/lib/database/models/order.model';
// deleteUserのPromise.allをいかに修正
    await Promise.all([
      // Update the 'events' collection to remove references to the user
      Event.updateMany({
        _id: { $in: userToDelete.orders }
      }, {
        $unset: { buyer: 1 }
      }),

      // Update the 'orders' collection to remove references to the user
      Order.updateMany({
        _id: { $in: userToDelete.orders }
      }, {
        $unset: { buyer: 1 }
      }),
    ]);
```
80.
81.